name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # PR Title Check
  pr-title:
    name: Check PR Title
    runs-on: ubuntu-latest

    steps:
      - name: Check PR title format
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            chore
            ci
          requireScope: false

  # Check for Breaking Changes
  breaking-changes:
    name: Check for Breaking Changes
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for breaking changes in PR
        run: |
          if git log --oneline ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | grep -i "BREAKING"; then
            echo "⚠️ This PR contains breaking changes"
            echo "breaking_changes=true" >> $GITHUB_ENV
          else
            echo "✅ No breaking changes detected"
            echo "breaking_changes=false" >> $GITHUB_ENV
          fi

  # File Size Check
  file-size:
    name: Check File Sizes
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for large files
        run: |
          echo "Checking for files larger than 1MB..."
          find . -type f -size +1M -not -path "./node_modules/*" -not -path "./.git/*" -not -path "./dist/*" -not -path "./coverage/*" | while read file; do
            size=$(du -h "$file" | cut -f1)
            echo "⚠️ Large file detected: $file ($size)"
          done

  # Dependencies Check
  dependencies:
    name: Check Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Check for outdated dependencies
        run: |
          npm outdated || true
          echo "Run 'npm update' to update dependencies"

      - name: Check package-lock.json
        run: |
          if git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep -q "package.json"; then
            if ! git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep -q "package-lock.json"; then
              echo "⚠️ package.json was modified but package-lock.json was not updated"
              echo "Please run 'npm install' to update package-lock.json"
              exit 1
            fi
          fi

  # Code Review Checklist
  checklist:
    name: PR Checklist
    runs-on: ubuntu-latest

    steps:
      - name: Comment checklist
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue_number = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Check if checklist comment already exists
            const comments = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number,
            });

            const checklistExists = comments.data.some(comment =>
              comment.body.includes('PR Review Checklist')
            );

            if (!checklistExists) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body: `## PR Review Checklist

            Please ensure the following before merging:

            ### Code Quality
            - [ ] Code follows project style guidelines
            - [ ] No console.log or debugging code left in
            - [ ] TypeScript types are properly defined
            - [ ] No any types unless absolutely necessary

            ### Testing
            - [ ] New features have corresponding tests
            - [ ] All tests pass locally
            - [ ] Test coverage is maintained or improved

            ### Documentation
            - [ ] README updated if needed
            - [ ] Comments added for complex logic
            - [ ] API changes documented

            ### Performance
            - [ ] No unnecessary re-renders
            - [ ] Large lists use virtualization if needed
            - [ ] Images are optimized

            ### Security
            - [ ] No sensitive data exposed
            - [ ] Input validation added
            - [ ] API calls use proper authentication

            ### Git
            - [ ] Commits are atomic and well-described
            - [ ] No merge conflicts
            - [ ] Branch is up to date with base branch

            ---
            *This checklist was automatically generated by GitHub Actions*
            `
              });
            }
